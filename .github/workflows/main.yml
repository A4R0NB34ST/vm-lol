name: üéÆ PC Gaming con LoL

on:
  workflow_dispatch:

jobs:
  gaming-pc:
    runs-on: windows-latest
    timeout-minutes: 360

    steps:
      - name: üîß Configurar Windows RDP
        run: |
          # Activar RDP
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0 -Force
          
          # Firewall para RDP
          netsh advfirewall firewall add rule name="RDP" dir=in action=allow protocol=TCP localport=3389
          
          # Reiniciar servicio
          Restart-Service TermService -Force
          
          echo "‚úÖ RDP Configurado"

      - name: üë§ Crear Usuario Gamer
        run: |
          # Contrase√±a: Gamer123! (puedes cambiarla)
          $Password = ConvertTo-SecureString "Gamer123!" -AsPlainText -Force
          
          # Crear usuario
          New-LocalUser -Name "Gamer" -Password $Password -AccountNeverExpires
          Add-LocalGroupMember -Group "Administrators" -Member "Gamer"
          Add-LocalGroupMember -Group "Remote Desktop Users" -Member "Gamer"
          
          echo "‚úÖ Usuario creado: Gamer / Gamer123!"

      - name: üåê Instalar y Configurar Tailscale
        run: |
          # Descargar Tailscale
          $TailscaleURL = "https://pkgs.tailscale.com/stable/tailscale-setup-latest-amd64.msi"
          $Installer = "$env:TEMP\tailscale.msi"
          Invoke-WebRequest -Uri $TailscaleURL -OutFile $Installer
          
          # Instalar
          Start-Process msiexec.exe -Wait -ArgumentList "/i", "`"$Installer`"", "/quiet", "/norestart"
          
          # Configurar (usa tu clave de Tailscale)
          & "$env:ProgramFiles\Tailscale\tailscale.exe" up --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} --hostname=github-gamer
          
          # Obtener IP
          Start-Sleep -Seconds 10
          $IP = & "$env:ProgramFiles\Tailscale\tailscale.exe" ip -4
          echo "TAILSCALE_IP=$IP" >> $env:GITHUB_ENV
          echo "‚úÖ Tailscale IP: $IP"

      - name: üéÆ Instalar League of Legends (SIN REINICIAR)
        run: |
          Write-Host "=== DESCARGANDO LEAGUE OF LEGENDS ==="
          
          # URL oficial de descarga
          $LOL_URL = "https://lol.secure.dyn.riotcdn.net/channels/public/x/installer/current/live.la2.exe"
          $LOL_Installer = "$env:TEMP\LeagueInstaller.exe"
          
          # Descargar
          Invoke-WebRequest -Uri $LOL_URL -OutFile $LOL_Installer
          Write-Host "‚úÖ Descargado - Tama√±o: $((Get-Item $LOL_Installer).Length / 1MB) MB"
          
          # Instalar sin reiniciar
          Write-Host "Instalando (esto puede tardar 5-10 minutos)..."
          Start-Process -FilePath $LOL_Installer -ArgumentList "--skip-to-game" -Wait -NoNewWindow
          
          # Verificar instalaci√≥n
          if (Test-Path "C:\Riot Games\League of Legends\LeagueClient.exe") {
              Write-Host "‚úÖ League of Legends INSTALADO CORRECTAMENTE"
          } else {
              Write-Host "‚ö†Ô∏è  Instalaci√≥n en progreso..."
          }

      - name: ‚öôÔ∏è Preparar Recuperaci√≥n Tras Reinicio
        run: |
          # Crear script de recuperaci√≥n
          $RecoveryScript = @'
          # Script para recuperar conexi√≥n despu√©s de reiniciar
          Start-Sleep -Seconds 30
          
          # 1. Activar Tailscale
          & "C:\Program Files\Tailscale\tailscale.exe" up --authkey=${{ secrets.TAILSCALE_AUTH_KEY }}
          
          # 2. Activar RDP
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0 -Force
          netsh advfirewall firewall add rule name="RDP" dir=in action=allow protocol=TCP localport=3389
          Restart-Service TermService -Force
          
          # 3. Mostrar IP nueva
          $NewIP = & "C:\Program Files\Tailscale\tailscale.exe" ip -4
          Write-Host "========================================"
          Write-Host "‚úÖ CONEXI√ìN RECUPERADA"
          Write-Host "Nueva IP: $NewIP"
          Write-Host "Usuario: Gamer"
          Write-Host "Contrase√±a: Gamer123!"
          Write-Host "========================================"
'@
          
          # Guardar script
          $RecoveryScript | Out-File "C:\Users\Public\Recovery.ps1"
          
          # Hacer que se ejecute al iniciar Windows
          $Action = New-ScheduledTaskAction -Execute "PowerShell.exe" -Argument "-ExecutionPolicy Bypass -File C:\Users\Public\Recovery.ps1"
          $Trigger = New-ScheduledTaskTrigger -AtStartup
          Register-ScheduledTask -TaskName "RecoveryGamingPC" -Action $Action -Trigger $Trigger -RunLevel Highest -Force
          
          echo "‚úÖ Sistema preparado para recuperaci√≥n tras reinicio"

      - name: üì¢ Mostrar Informaci√≥n de Conexi√≥n
        run: |
          Write-Host ""
          Write-Host "========================================"
          Write-Host "üéÆ PC GAMING LISTA üéÆ"
          Write-Host "========================================"
          Write-Host ""
          Write-Host "üåê CON√âCTATE CON:"
          Write-Host "   IP: $env:TAILSCALE_IP"
          Write-Host "   Usuario: Gamer"
          Write-Host "   Contrase√±a: Gamer123!"
          Write-Host ""
          Write-Host "‚è∞ DURACI√ìN: 6 horas m√°ximo"
          Write-Host "‚ö†Ô∏è  Si reinicias, espera 1 minuto y reconecta"
          Write-Host "‚ö†Ô∏è  Si pierdes conexi√≥n, Tailscale reconecta autom√°tico"
          Write-Host ""
          Write-Host "üéÆ League of Legends ya est√° instalado"
          Write-Host "üìç Ruta: C:\Riot Games\League of Legends"
          Write-Host "========================================"
          Write-Host ""

      - name: ‚è≥ Mantener PC Encendida
        run: |
          # Mantener activa por 5 horas y 50 minutos
          $Horas = 5
          $Minutos = 50
          $TotalSegundos = ($Horas * 3600) + ($Minutos * 60)
          
          Write-Host "‚è∞ Manteniendo PC activa por $Horas horas y $Minutos minutos..."
          Write-Host "‚ùå Para apagar: Ve a GitHub Actions > Cancela este workflow"
          
          # Contador regresivo
          for ($i = $TotalSegundos; $i -gt 0; $i--) {
              $HorasRestantes = [math]::Floor($i / 3600)
              $MinutosRestantes = [math]::Floor(($i % 3600) / 60)
              $SegundosRestantes = $i % 60
              
              Write-Host "Tiempo restante: ${HorasRestantes}h ${MinutosRestantes}m ${SegundosRestantes}s"
              Start-Sleep -Seconds 1
          }
          
          Write-Host "‚è∞ Tiempo agotado - PC se apagar√°"
